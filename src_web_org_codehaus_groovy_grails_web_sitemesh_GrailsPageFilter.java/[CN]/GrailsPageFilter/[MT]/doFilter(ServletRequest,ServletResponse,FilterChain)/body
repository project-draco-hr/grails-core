{
  HttpServletRequest request=(HttpServletRequest)rq;
  if (rq.getAttribute(FILTER_APPLIED) != null || factory.isPathExcluded(extractRequestPath(request))) {
    chain.doFilter(rq,rs);
  }
 else {
    request.setAttribute(FILTER_APPLIED,Boolean.TRUE);
    factory.refresh();
    DecoratorMapper decoratorMapper=factory.getDecoratorMapper();
    HttpServletResponse response=(HttpServletResponse)rs;
    Page page=parsePage(request,response,chain);
    if (page != null) {
      page.setRequest(request);
      Decorator decorator=decoratorMapper.getDecorator(request,page);
      if (decorator != null && decorator.getPage() != null) {
        applyDecorator(page,decorator,request,response);
        return;
      }
      writeOriginal(request,response,page);
    }
  }
}
