{
  HibernateTemplate t=getHibernateTemplate();
  Errors errors=new BindException(target,target.getClass().getName());
  GrailsDomainClass domainClass=application.getGrailsDomainClass(target.getClass().getName());
  Validator validator=null;
  boolean doValidation=true;
  if (domainClass != null) {
    validator=domainClass.getValidator();
    doValidation=true;
    if (arguments.length > 0) {
      if (arguments[0] instanceof Boolean) {
        doValidation=((Boolean)arguments[0]).booleanValue();
      }
    }
  }
  if (doValidation) {
    if (validator != null) {
      if (validator instanceof GrailsDomainClassValidator) {
        ((GrailsDomainClassValidator)validator).setHibernateTemplate(getHibernateTemplate());
      }
      validator.validate(target,errors);
      if (errors.hasErrors()) {
        if (t.contains(target)) {
          t.evict(target);
        }
        DelegatingMetaClass metaClass=(DelegatingMetaClass)InvokerHelper.getInstance().getMetaRegistry().getMetaClass(target.getClass());
        metaClass.setProperty(target,DomainClassMethods.ERRORS_PROPERTY,errors);
        return null;
      }
    }
  }
  if (domainClass != null) {
    BeanWrapper bean=new BeanWrapperImpl(target);
    GrailsDomainClassProperty[] props=domainClass.getPersistantProperties();
    for (int i=0; i < props.length; i++) {
      GrailsDomainClassProperty prop=props[i];
      if (prop.isManyToOne() || prop.isOneToOne()) {
        Object propValue=bean.getPropertyValue(prop.getName());
        if (propValue != null && !t.contains(propValue)) {
          GrailsDomainClass otherSide=application.getGrailsDomainClass(prop.getType().getName());
          if (otherSide != null) {
            BeanWrapper propBean=new BeanWrapperImpl(propValue);
            Serializable id=(Serializable)propBean.getPropertyValue(otherSide.getIdentifier().getName());
            if (id != null) {
              bean.setPropertyValue(prop.getName(),t.get(prop.getType(),id));
            }
          }
        }
      }
    }
  }
  t.saveOrUpdate(target);
  return target;
}
