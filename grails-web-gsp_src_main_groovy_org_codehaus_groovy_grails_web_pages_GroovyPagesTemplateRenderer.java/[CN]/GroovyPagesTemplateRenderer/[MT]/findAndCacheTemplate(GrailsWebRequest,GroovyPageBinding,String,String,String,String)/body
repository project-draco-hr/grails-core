{
  String templatePath=GrailsStringUtils.isNotEmpty(contextPath) ? GrailsResourceUtils.appendPiecesForUri(contextPath,templateName) : templateName;
  GroovyPageScriptSource scriptSource;
  if (pluginName == null) {
    scriptSource=groovyPageLocator.findTemplateInBinding(templatePath,pageScope);
  }
 else {
    scriptSource=groovyPageLocator.findTemplateInBinding(pluginName,templatePath,pageScope);
  }
  String cacheKey;
  if (scriptSource == null) {
    cacheKey=contextPath + pluginName + uri;
  }
 else {
    cacheKey=scriptSource.getURI();
  }
  TemplateRendererCacheEntry cacheEntry=templateCache.get(cacheKey);
  if (cacheEntry != null && cacheEntry.isValid()) {
    return cacheEntry.template;
  }
  Template t=null;
  try {
    if (cacheEntry != null) {
      cacheEntry.getLock().lock();
      if (cacheEntry.isValid()) {
        t=cacheEntry.template;
      }
    }
    if (t == null) {
      if (scriptSource != null) {
        t=groovyPagesTemplateEngine.createTemplate(scriptSource);
      }
      boolean allowCaching=!disableCache;
      if (t == null && scaffoldingTemplateGenerator != null) {
        t=generateScaffoldedTemplate(webRequest,uri);
        allowCaching=true;
      }
      if (t != null && allowCaching) {
        if (cacheEntry == null) {
          templateCache.put(cacheKey,new TemplateRendererCacheEntry(t,reloadEnabled));
        }
 else {
          cacheEntry.setTemplate(t);
        }
      }
    }
  }
  finally {
    if (cacheEntry != null) {
      cacheEntry.getLock().unlock();
    }
  }
  return t;
}
