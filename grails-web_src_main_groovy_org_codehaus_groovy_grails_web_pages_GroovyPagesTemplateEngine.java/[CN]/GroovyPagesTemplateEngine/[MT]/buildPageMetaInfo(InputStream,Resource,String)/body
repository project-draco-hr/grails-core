{
  String name=establishPageName(res,pageName);
  GroovyPageParser parser;
  String path=getPathForResource(res);
  try {
    String encoding=GroovyPageParser.DEFAULT_ENCODING;
    if (grailsApplication != null) {
      ConfigObject config=grailsApplication.getConfig();
      Object gspEnc=config.get(GroovyPageParser.CONFIG_PROPERTY_GSP_ENCODING);
      if ((gspEnc != null) && (gspEnc.toString().trim().length() > 0)) {
        encoding=gspEnc.toString();
      }
    }
    parser=new GroovyPageParser(name,path,path,inputStream,encoding);
    if (grailsApplication != null) {
      ConfigObject config=grailsApplication.getConfig();
      Object sitemeshPreprocessEnabled=config.get(GroovyPageParser.CONFIG_PROPERTY_GSP_SITEMESH_PREPROCESS);
      if (sitemeshPreprocessEnabled != null) {
        final boolean enableSitemeshPreprocessing=BooleanUtils.toBoolean(String.valueOf(sitemeshPreprocessEnabled).trim());
        parser.setEnableSitemeshPreprocessing(enableSitemeshPreprocessing);
      }
      Object keepDirObj=config.get(GroovyPageParser.CONFIG_PROPERTY_GSP_KEEPGENERATED_DIR);
      if (keepDirObj instanceof File) {
        parser.setKeepGeneratedDirectory((File)keepDirObj);
      }
 else       if (keepDirObj != null) {
        parser.setKeepGeneratedDirectory(new File(String.valueOf(keepDirObj)));
      }
    }
  }
 catch (  IOException e) {
    throw new GroovyPagesException("I/O parsing Groovy page [" + (res != null ? res.getDescription() : name) + "]: "+ e.getMessage(),e);
  }
  InputStream in=parser.parse();
  GroovyPageMetaInfo metaInfo=createPageMetaInfo(parser,in);
  metaInfo.applyLastModifiedFromResource(res);
  try {
    metaInfo.setPageClass(compileGroovyPage(in,name,path,metaInfo));
    metaInfo.setHtmlParts(parser.getHtmlPartsArray());
  }
 catch (  GroovyPagesException e) {
    metaInfo.setCompilationException(e);
  }
  if (!name.startsWith(GENERATED_GSP_NAME_PREFIX)) {
    pageCache.put(name,metaInfo);
  }
  return metaInfo;
}
