{
  if (LOG.isDebugEnabled())   LOG.debug("parse: page");
  if (finalPass) {
    out.println();
    out.print("class ");
    out.print(className);
    out.println(" extends GroovyPage {");
    out.println("public String getGroovyPageFileName() { \"" + pageName.replaceAll("\\\\","/") + "\" }");
    out.println("public Object run() {");
    out.println("def params = binding.params");
    out.println("def request = binding.request");
    out.println("def flash = binding.flash");
    out.println("def response = binding.response");
    if (codecClassName != null) {
      out.println("request.setAttribute('org.codehaus.groovy.grails.GSP_CODEC', '" + codecName + "')");
    }
  }
  loop:   for (; ; ) {
    if (doNextScan)     state=scan.nextToken();
 else     doNextScan=true;
    if ((state != GSTART_TAG) && (state != HTML)) {
      flushBufferedWhiteSpace();
      previousContentWasNonWhitespace=false;
    }
switch (state) {
case EOF:
      break loop;
case HTML:
    html();
  break;
case JEXPR:
scriptletExpr();
break;
case JSCRIPT:
script(false);
break;
case JDIRECT:
direct();
break;
case JDECLAR:
declare(false);
break;
case GEXPR:
expr();
break;
case GSCRIPT:
script(true);
break;
case GDIRECT:
direct();
break;
case GDECLAR:
declare(true);
break;
case GSTART_TAG:
startTag();
break;
case GEND_TAG:
endTag();
break;
}
}
if (finalPass) {
if (!tagMetaStack.isEmpty()) {
TagMeta tag=(TagMeta)tagMetaStack.iterator().next();
throw new GrailsTagException("Grails tags were not closed! [" + tagMetaStack + "] in GSP "+ pageName+ "",pageName,out.getCurrentLineNumber());
}
out.println("}");
for (Iterator i=constants.keySet().iterator(); i.hasNext(); ) {
String name=(String)i.next();
out.println("static final " + name + " = "+ constants.get(name));
}
out.println("}");
}
 else {
for (int i=0; i < DEFAULT_IMPORTS.length; i++) {
out.print("import ");
out.println(DEFAULT_IMPORTS[i]);
}
if (codecClassName != null) {
out.print("import ");
out.print(codecClassName);
out.println(" as Codec");
}
}
}
