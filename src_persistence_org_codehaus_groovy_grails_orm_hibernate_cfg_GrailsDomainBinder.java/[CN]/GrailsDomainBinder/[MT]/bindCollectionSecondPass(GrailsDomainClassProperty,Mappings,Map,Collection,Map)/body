{
  if (collection.isOneToMany()) {
    OneToMany oneToMany=(OneToMany)collection.getElement();
    String associatedClassName=oneToMany.getReferencedEntityName();
    PersistentClass persistentClass=(PersistentClass)persistentClasses.get(associatedClassName);
    if (persistentClass == null) {
      throw new MappingException("Association references unmapped class: " + oneToMany.getReferencedEntityName());
    }
    oneToMany.setAssociatedClass(persistentClass);
    collection.setCollectionTable(persistentClass.getTable());
    LOG.info("Mapping collection: " + collection.getRole() + " -> "+ collection.getCollectionTable().getName());
  }
  KeyValue keyValue;
  String propertyRef=collection.getReferencedPropertyName();
  if (propertyRef == null) {
    keyValue=collection.getOwner().getIdentifier();
  }
 else {
    keyValue=(KeyValue)collection.getOwner().getProperty(propertyRef).getValue();
  }
  keyValue.setTypeUsingReflection(property.getReferencedDomainClass().getName(),collection.getReferencedPropertyName());
  DependantValue key=new DependantValue(collection.getCollectionTable(),keyValue);
  key.setTypeUsingReflection(property.getReferencedDomainClass().getName(),collection.getReferencedPropertyName());
  bindSimpleValue(property,key,mappings);
  collection.setKey(key);
  key.setNullable(false);
  key.setUpdateable(false);
  if (property.isManyToMany()) {
    ManyToOne element=new ManyToOne(collection.getCollectionTable());
    collection.setElement(element);
    bindManyToOne(property,element,mappings);
  }
 else   if (property.isOneToMany()) {
    String entityName=((OneToMany)collection.getElement()).getReferencedEntityName();
    PersistentClass referenced=mappings.getClass(entityName);
    Backref prop=new Backref();
    prop.setName('_' + property.getName() + "Backref");
    prop.setUpdateable(false);
    prop.setSelectable(false);
    prop.setCollectionRole(collection.getRole());
    prop.setValue(collection.getKey());
    referenced.addProperty(prop);
  }
}
