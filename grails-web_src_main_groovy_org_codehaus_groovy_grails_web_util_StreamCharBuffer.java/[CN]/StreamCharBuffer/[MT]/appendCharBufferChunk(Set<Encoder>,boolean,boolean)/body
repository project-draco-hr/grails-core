{
  int spaceLeft=0;
  if (flushInConnected && isConnectedMode()) {
    flushToConnected();
    if (!isChunkSizeResizeable()) {
      allocBuffer.reuseBuffer(encoders);
      spaceLeft=allocBuffer.spaceLeft(encoders);
    }
 else {
      spaceLeft=0;
    }
  }
 else {
    if (allocBuffer.hasChunk()) {
      addChunk(allocBuffer.createChunk());
    }
    spaceLeft=allocBuffer.spaceLeft(encoders);
  }
  if (allocate && spaceLeft == 0) {
    totalChunkSize+=allocBuffer.chunkSize();
    resizeChunkSizeAsProcentageOfTotalSize();
    allocBuffer=new AllocatedBuffer(chunkSize);
    spaceLeft=allocBuffer.spaceLeft(encoders);
  }
  return spaceLeft;
}
