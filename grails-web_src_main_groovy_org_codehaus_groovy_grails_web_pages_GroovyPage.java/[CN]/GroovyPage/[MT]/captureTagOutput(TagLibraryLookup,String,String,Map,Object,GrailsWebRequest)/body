{
  if (!(attrs instanceof GroovyPageAttributes)) {
    attrs=new GroovyPageAttributes(attrs);
  }
  GroovyObject tagLib=lookupCachedTagLib(gspTagLibraryLookup,namespace,tagName);
  if (tagLib == null) {
    throw new GrailsTagException("Tag [" + tagName + "] does not exist. No corresponding tag library found.");
  }
  Closure actualBody=createOutputCapturingClosure(tagLib,body,webRequest);
  final GroovyPageTagWriter out=new GroovyPageTagWriter();
  try {
    GroovyPageOutputStack outputStack=GroovyPageOutputStack.currentStack(webRequest,false);
    if (outputStack == null) {
      outputStack=GroovyPageOutputStack.currentStack(webRequest,true,out,true,true);
    }
    outputStack.push(out);
    Object tagLibProp=tagLib.getProperty(tagName);
    if (tagLibProp instanceof Closure) {
      Closure tag=(Closure)((Closure)tagLibProp).clone();
      Object bodyResult;
switch (tag.getParameterTypes().length) {
case 1:
        bodyResult=tag.call(new Object[]{attrs});
      if (actualBody != null && actualBody != EMPTY_BODY_CLOSURE) {
        Object bodyResult2=actualBody.call();
        if (bodyResult2 != null) {
          out.print(bodyResult2);
        }
      }
    break;
case 2:
  bodyResult=tag.call(new Object[]{attrs,actualBody});
break;
default :
throw new GrailsTagException("Tag [" + tagName + "] does not specify expected number of params in tag library ["+ tagLib.getClass().getName()+ "]");
}
boolean returnsObject=gspTagLibraryLookup.doesTagReturnObject(namespace,tagName);
if (returnsObject && bodyResult != null && !(bodyResult instanceof Writer)) {
return bodyResult;
}
return out.getBuffer();
}
throw new GrailsTagException("Tag [" + tagName + "] does not exist in tag library ["+ tagLib.getClass().getName()+ "]");
}
  finally {
GroovyPageOutputStack.currentStack(webRequest).pop();
}
}
