{
  GrailsConsoleResultFormatter consoleFormatter=new GrailsConsoleResultFormatter();
  TestResult result=new TestResult();
  result.addListener(consoleFormatter);
  for (Enumeration tests=suite.tests(); tests.hasMoreElements(); ) {
    TestSuite test=(TestSuite)tests.nextElement();
    reset();
    JUnitTest junitTest=new JUnitTest(test.getName());
    try {
      prepareReports(test);
      consoleFormatter.setOutput(System.out);
      outAndErrSwapper.swapIn();
      consoleFormatter.startTestSuite(junitTest);
      for (      FormattedOutput output : formattedOutputs) {
        result.addListener(output.getFormatter());
        output.start(junitTest);
      }
      long start=System.currentTimeMillis();
      int runCount=result.runCount();
      int failureCount=result.failureCount();
      int errorCount=result.errorCount();
      for (int i=0; i < test.testCount(); i++) {
        TestCase t=(TestCase)test.testAt(i);
        System.out.println("--Output from " + t.getName() + "--");
        System.err.println("--Output from " + t.getName() + "--");
        test.runTest(t,result);
      }
      junitTest.setCounts(result.runCount() - runCount,result.failureCount() - failureCount,result.errorCount() - errorCount);
      junitTest.setRunTime(System.currentTimeMillis() - start);
    }
  finally {
      List<OutputStream> outAndErr=outAndErrSwapper.swapOut();
      String out=outAndErr.get(0).toString();
      String err=outAndErr.get(1).toString();
      for (      FormattedOutput output : formattedOutputs) {
        output.end(junitTest,out,err);
      }
      consoleFormatter.endTestSuite(junitTest);
    }
  }
  return result;
}
