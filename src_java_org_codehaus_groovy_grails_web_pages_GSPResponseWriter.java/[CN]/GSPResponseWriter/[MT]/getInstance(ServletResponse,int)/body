{
  Writer target=null;
  StreamCharBuffer streamBuffer=null;
  BoundedCharsAsEncodedBytesCounter bytesCounter=null;
  if (!(response instanceof GrailsContentBufferingResponse) && (BUFFERING_ENABLED || CONTENT_LENGTH_COUNTING_ENABLED)) {
    streamBuffer=new StreamCharBuffer(max,0,max);
    target=streamBuffer.getWriter();
    if (CONTENT_LENGTH_COUNTING_ENABLED) {
      bytesCounter=new BoundedCharsAsEncodedBytesCounter(max * 2,response.getCharacterEncoding());
      streamBuffer.connectTo(bytesCounter.getCountingWriter(),true);
    }
    streamBuffer.connectTo(new StreamCharBuffer.LazyInitializingWriter(){
      public Writer getWriter() throws IOException {
        return response.getWriter();
      }
    }
,!CONTENT_LENGTH_COUNTING_ENABLED);
  }
 else {
    try {
      target=response.getWriter();
    }
 catch (    IOException e) {
      LOG.error("Problem getting writer from response",e);
      throw new RuntimeException("Problem getting writer from response",e);
    }
  }
  return new GSPResponseWriter(target,response,bytesCounter);
}
