{
  if (test instanceof TestCase && applicationContext != null) {
    applicationContext.getAutowireCapableBeanFactory().autowireBeanProperties(test,AutowireCapableBeanFactory.AUTOWIRE_BY_NAME,false);
  }
  if (test instanceof ApplicationContextAware && applicationContext != null) {
    ((ApplicationContextAware)test).setApplicationContext(applicationContext);
  }
  try {
    GrailsWebRequest webRequest=GrailsWebUtil.bindMockWebRequest(applicationContext);
    ServletContextHolder.setServletContext(webRequest.getServletContext());
    webRequest.getServletContext().setAttribute(GrailsApplicationAttributes.APPLICATION_CONTEXT,applicationContext);
    if (isTransactional(test)) {
      if (applicationContext.containsBean("transactionManager")) {
        TransactionTemplate template=new TransactionTemplate((PlatformTransactionManager)applicationContext.getBean("transactionManager"));
        template.execute(new TransactionCallback(){
          public Object doInTransaction(          TransactionStatus status){
            test.run(result);
            status.setRollbackOnly();
            return null;
          }
        }
);
      }
 else {
        throw new RuntimeException("There is no test TransactionManager defined and integration " + "test ${test.name} does not set transactional = false");
      }
    }
 else {
      test.run(result);
    }
  }
  finally {
    RequestContextHolder.setRequestAttributes(null);
    ServletContextHolder.setServletContext(null);
  }
}
