{
  if (applicationContext instanceof GenericApplicationContext) {
    GenericApplicationContext ctx=(GenericApplicationContext)applicationContext;
    GrailsDataSource dataSource=application.getGrailsDataSource();
    RootBeanDefinition bd=new RootBeanDefinition(ConfigurableLocalSessionFactoryBean.class);
    MutablePropertyValues mpv=new MutablePropertyValues();
    mpv.addPropertyValue("dataSource",new RuntimeBeanReference("dataSource"));
    Properties hibernateProperties=new Properties();
    if (dataSource != null && dataSource.getDbCreate() != null) {
      hibernateProperties.setProperty("hibernate.hbm2ddl.auto",dataSource.getDbCreate());
    }
    mpv.addPropertyValue("hibernateProperties",hibernateProperties);
    Resource hibernateConfigFile=new ClassPathResource("hibernate.cfg.xml");
    if (hibernateConfigFile.exists()) {
      mpv.addPropertyValue("configLocation","classpath:hibernate.cfg.xml");
    }
    bd.setPropertyValues(mpv);
    ctx.registerBeanDefinition("sessionFactory",bd);
  }
}
