{
  super.setUp();
  onSetUp();
  ga=new DefaultGrailsApplication(gcl.getLoadedClasses(),gcl);
  MockApplicationContext mc=new MockApplicationContext();
  mc.registerMockBean(GrailsApplication.APPLICATION_ID,ga);
  GrailsRuntimeConfigurator grc=new GrailsRuntimeConfigurator(ga,mc);
  this.applicationContext=grc.configureDomainOnly();
  this.sessionFactory=(SessionFactory)this.applicationContext.getBean(GrailsRuntimeConfigurator.SESSION_FACTORY_BEAN);
  GrailsDomainConfigurationUtil.configureDynamicMethods(sessionFactory,ga);
  if (!TransactionSynchronizationManager.hasResource(this.sessionFactory)) {
    this.session=this.sessionFactory.openSession();
    TransactionSynchronizationManager.bindResource(this.sessionFactory,new SessionHolder(session));
  }
}
