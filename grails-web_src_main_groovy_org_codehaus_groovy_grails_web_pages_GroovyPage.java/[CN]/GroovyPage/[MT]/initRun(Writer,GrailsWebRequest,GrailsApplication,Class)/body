{
  outputStack=GroovyPageOutputStack.currentStack(true,target,false,true);
  outputStack.registerOutputChangeListener(this);
  out=outputStack.getProxyWriter();
  this.webRequest=grailsWebRequest;
  if (grailsWebRequest != null) {
    grailsWebRequest.setOut(out);
    request=grailsWebRequest.getCurrentRequest();
  }
  setVariableDirectly(OUT,out);
  encoder=null;
  if (grailsApplication != null && codecClass != null) {
    GrailsCodecClass codecArtefact=(GrailsCodecClass)grailsApplication.getArtefact("Codec",codecClass.getName());
    encoder=codecArtefact.getEncoder();
  }
  encodingStateRegistry=DefaultGrailsCodecClass.getEncodingStateRegistryLookup() != null ? DefaultGrailsCodecClass.getEncodingStateRegistryLookup().lookup() : null;
  codecOut=new GrailsPrintWriter(null){
    @Override public boolean isAllowUnwrappingOut(){
      return encoder == null;
    }
    @Override protected Writer unwrapWriter(    Writer writer){
      return writer;
    }
  }
;
  outputChanged(((GrailsPrintWriter)out).getOut());
  setVariableDirectly(CODEC_OUT,codecOut);
}
