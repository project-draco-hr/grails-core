{
  if (isPersistenceContext(session.getDefinition())) {
    final Session hibernateSession=(Session)session.getScope().remove(HIBERNATE_SESSION_ATTRIBUTE);
    Boolean commitStatus=session.getState().getAttributes().getBoolean("commit");
    if (Boolean.TRUE.equals(commitStatus)) {
      try {
        if (TransactionSynchronizationManager.hasResource(localSessionFactory)) {
          SessionHolder sessionHolder=(SessionHolder)TransactionSynchronizationManager.getResource(localSessionFactory);
          sessionHolder.addSession(hibernateSession);
        }
        localTransactionTemplate.execute(new TransactionCallbackWithoutResult(){
          protected void doInTransactionWithoutResult(          TransactionStatus status){
            localSessionFactory.getCurrentSession();
          }
        }
);
      }
  finally {
        if (TransactionSynchronizationManager.hasResource(localSessionFactory)) {
          SessionHolder sessionHolder=(SessionHolder)TransactionSynchronizationManager.getResource(localSessionFactory);
          sessionHolder.removeSession(hibernateSession);
        }
      }
    }
    unbind(hibernateSession);
    hibernateSession.close();
  }
}
