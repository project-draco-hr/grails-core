{
  request.setAttribute(GrailsApplicationAttributes.REQUEST_SCOPE_ID,grailsAttributes);
  this.engine=grailsAttributes.getPagesTemplateEngine();
  this.engine.setShowSource(this.showSource);
  String pageId=(String)request.getAttribute(GrailsApplicationAttributes.GSP_TO_RENDER);
  if (pageId == null)   pageId=engine.getPageId(request);
  URL pageUrl=engine.getPageUrl(context,pageId);
  if (pageUrl == null) {
    context.log("GroovyPagesServlet:  \"" + pageUrl + "\" not found");
    response.sendError(404,"\"" + pageUrl + "\" not found.");
    return;
  }
  Template t=engine.createTemplate(context,request,response);
  if (t == null) {
    context.log("GroovyPagesServlet:  \"" + pageUrl + "\" not found");
    response.sendError(404,"\"" + pageUrl + "\" not found.");
    return;
  }
  Writable w=t.make();
  Writer out=GSPResonseWriter.getInstance(response,8192);
  try {
    w.writeTo(out);
  }
 catch (  Exception e) {
    LOG.debug("Error processing GSP: " + e.getMessage(),e);
    request.setAttribute("exception",new GrailsWrappedRuntimeException(context,e));
    RequestDispatcher rd=request.getRequestDispatcher("/WEB-INF/grails-app/views/error.gsp");
    if (response.isCommitted()) {
      rd.include(request,response);
    }
 else {
      rd.forward(request,response);
    }
  }
 finally {
    if (out != null)     out.close();
  }
}
