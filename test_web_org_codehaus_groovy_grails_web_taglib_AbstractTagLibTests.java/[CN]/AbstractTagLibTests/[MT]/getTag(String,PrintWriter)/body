{
  assertNotNull(applicationContext);
  assertNotNull(grailsApplication);
  GrailsControllerClass controllerClass=grailsApplication.getController("TestController");
  if (controllerClass == null) {
    Class groovyClass=grailsApplication.getClassLoader().parseClass("class TestController {\n" + "def list = {}\n" + "}");
    controllerClass=grailsApplication.addControllerClass(groovyClass);
  }
  GrailsTagLibClass tagClass=grailsApplication.getTagLibClassForTag(name);
  if (tagClass == null)   return null;
  GroovyObject mockController=(GroovyObject)controllerClass.newInstance();
  GroovyObject tagLibrary=(GroovyObject)tagClass.newInstance();
  MockServletContext servletContext=new MockServletContext();
  MockApplicationContext appContext=new MockApplicationContext();
  appContext.registerMockBean("grailsApplication",grailsApplication);
  servletContext.setAttribute(GrailsApplicationAttributes.APPLICATION_CONTEXT,appContext);
  GrailsControllerHelper helper=new SimpleGrailsControllerHelper(grailsApplication,appContext,servletContext);
  HttpServletRequest request=new MockHttpServletRequest(servletContext);
  request.setAttribute(GrailsApplicationAttributes.CONTROLLER,mockController);
  request.setAttribute(DispatcherServlet.LOCALE_RESOLVER_ATTRIBUTE,new AcceptHeaderLocaleResolver());
  HttpServletResponse response=new MockHttpServletResponse();
  new ControllerDynamicMethods(mockController,helper,request,response);
  new TagLibDynamicMethods(tagLibrary,mockController);
  for (int i=0; i < grailsApplication.getGrailsTabLibClasses().length; i++) {
    GroovyObject instance=(GroovyObject)grailsApplication.getGrailsTabLibClasses()[i].newInstance();
    new TagLibDynamicMethods(instance,mockController);
    instance.setProperty(TagLibDynamicMethods.OUT_PROPERTY,out);
    appContext.registerMockBean(grailsApplication.getGrailsTabLibClasses()[i].getFullName(),instance);
  }
  tagLibrary.setProperty(TagLibDynamicMethods.OUT_PROPERTY,out);
  return (Closure)tagLibrary.getProperty(name);
}
