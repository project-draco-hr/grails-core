{
  if (response.isCommitted())   return;
  int statusCode;
  if (request.getAttribute("javax.servlet.error.status_code") != null) {
    statusCode=Integer.parseInt(request.getAttribute("javax.servlet.error.status_code").toString());
  }
 else {
    statusCode=500;
  }
  Throwable t=null;
  if (request.getAttribute("javax.servlet.error.exception") != null) {
    t=(Throwable)request.getAttribute("javax.servlet.error.exception");
    if (!(t instanceof GrailsWrappedRuntimeException) && request.getAttribute("exception") == null) {
      request.setAttribute("exception",new GrailsWrappedRuntimeException(getServletContext(),t));
    }
  }
  final UrlMappingsHolder urlMappingsHolder=(UrlMappingsHolder)getBean(UrlMappingsHolder.BEAN_ID);
  UrlMappingInfo urlMappingInfo=null;
  if (t != null) {
    createStackTraceFilterer().filter(t,true);
    urlMappingInfo=urlMappingsHolder.matchStatusCode(statusCode,t);
    if (urlMappingInfo == null) {
      urlMappingInfo=urlMappingsHolder.matchStatusCode(statusCode,GrailsExceptionResolver.getRootCause(t));
    }
  }
  if (urlMappingInfo == null) {
    urlMappingInfo=urlMappingsHolder.matchStatusCode(statusCode);
  }
  if (urlMappingInfo == null) {
    renderDefaultResponse(response,statusCode);
    return;
  }
  RequestAttributes requestAttributes=RequestContextHolder.getRequestAttributes();
  boolean restoreOriginalRequestAttributes=false;
  final GrailsWebRequest webRequest;
  if (requestAttributes instanceof GrailsWebRequest) {
    webRequest=(GrailsWebRequest)requestAttributes;
    urlMappingInfo.configure(webRequest);
  }
 else {
    restoreOriginalRequestAttributes=true;
    webRequest=new GrailsWebRequest(request,response,getServletContext());
    RequestContextHolder.setRequestAttributes(webRequest);
    urlMappingInfo.configure(webRequest);
  }
  webRequest.removeAttribute(GrailsApplicationAttributes.GRAILS_CONTROLLER_CLASS_AVAILABLE,WebRequest.SCOPE_REQUEST);
  HttpServletResponse originalResponse=WrappedResponseHolder.getWrappedResponse();
  try {
    WrappedResponseHolder.setWrappedResponse(response);
    String viewName=urlMappingInfo.getViewName();
    if (viewName == null || viewName.endsWith(GSP_SUFFIX) || viewName.endsWith(JSP_SUFFIX)) {
      GrailsClass controller=WebUtils.passControllerForUrlMappingInfoInRequest(webRequest,urlMappingInfo,webRequest.getApplicationContext().getBean(UrlConverter.BEAN_NAME,UrlConverter.class),webRequest.getAttributes().getGrailsApplication());
      if (controller != null) {
        WebUtils.forwardRequestForUrlMappingInfo(request,response,urlMappingInfo,Collections.EMPTY_MAP);
      }
    }
 else {
      ViewResolver viewResolver=WebUtils.lookupViewResolver(getServletContext());
      if (viewResolver != null) {
        View v;
        try {
          if (!response.isCommitted()) {
            response.setContentType("text/html;charset=" + defaultEncoding);
          }
          v=WebUtils.resolveView(request,urlMappingInfo,viewName,viewResolver);
          v.render(Collections.EMPTY_MAP,request,response);
        }
 catch (        Throwable e) {
          createStackTraceFilterer().filter(e);
          renderDefaultResponse(response,statusCode,"Internal Server Error",e.getMessage());
        }
      }
    }
  }
  finally {
    WrappedResponseHolder.setWrappedResponse(originalResponse);
    if (restoreOriginalRequestAttributes) {
      RequestContextHolder.setRequestAttributes(requestAttributes);
    }
  }
}
