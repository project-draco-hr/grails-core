{
  StreamCharBuffer coded=new StreamCharBuffer(Math.min(Math.max(totalChunkSize,chunkSize) * 12 / 10,maxChunkSize));
  Writer codedWriter=coded.getWriter();
  if (StreamingHTMLEncoderHelper.disabled) {
    try {
      codedWriter.write(HtmlUtils.htmlEscape(toString()));
    }
 catch (    IOException e) {
      log.error("IOException in StreamCharBuffer.encodeAsHTML",e);
    }
  }
 else {
    Reader reader=getReader();
    char[] buf=new char[1];
    try {
      while (reader.read(buf) != -1) {
        String reference=StreamingHTMLEncoderHelper.convertToReference(buf[0]);
        if (reference != null) {
          codedWriter.write(reference);
        }
 else {
          codedWriter.write(buf);
        }
      }
    }
 catch (    IOException e) {
      log.error("IOException in StreamCharBuffer.encodeAsHTML",e);
    }
  }
  return coded;
}
