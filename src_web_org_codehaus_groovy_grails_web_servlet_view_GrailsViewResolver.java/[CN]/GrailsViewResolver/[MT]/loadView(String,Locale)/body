{
  if (this.templateEngine == null)   throw new IllegalStateException("Property [templateEngine] cannot be null");
  if (this.pluginMetaManager == null)   throw new IllegalStateException("Property [pluginMetaManager] cannot be null");
  if (VIEW_CACHE.containsKey(viewName) && !templateEngine.isReloadEnabled()) {
    return VIEW_CACHE.get(viewName);
  }
 else {
    GrailsWebRequest webRequest=WebUtils.retrieveGrailsWebRequest();
    HttpServletRequest request=webRequest.getCurrentRequest();
    GroovyObject controller=webRequest.getAttributes().getController(request);
    GrailsApplication application=(GrailsApplication)getApplicationContext().getBean(GrailsApplication.APPLICATION_ID);
    ResourceLoader resourceLoader=establishResourceLoader(application);
    String format=request.getAttribute(GrailsApplicationAttributes.CONTENT_FORMAT) != null ? request.getAttribute(GrailsApplicationAttributes.CONTENT_FORMAT).toString() : null;
    String gspView=localPrefix + viewName + DOT+ format+ GSP_SUFFIX;
    Resource res=null;
    if (format != null) {
      res=resourceLoader.getResource(gspView);
      if (!res.exists()) {
        gspView=resolveViewForController(controller,application,viewName,resourceLoader);
        res=resourceLoader.getResource(gspView);
      }
    }
    if (res == null || !res.exists()) {
      gspView=localPrefix + viewName + GSP_SUFFIX;
      res=resourceLoader.getResource(gspView);
      if (!res.exists()) {
        gspView=resolveViewForController(controller,application,viewName,resourceLoader);
        res=resourceLoader.getResource(gspView);
      }
    }
    if (res.exists()) {
      final View view=createGroovyPageView(webRequest,gspView);
      VIEW_CACHE.put(viewName,view);
      return view;
    }
 else {
      AbstractUrlBasedView view=buildView(viewName);
      view.setApplicationContext(getApplicationContext());
      view.afterPropertiesSet();
      VIEW_CACHE.put(viewName,view);
      return view;
    }
  }
}
