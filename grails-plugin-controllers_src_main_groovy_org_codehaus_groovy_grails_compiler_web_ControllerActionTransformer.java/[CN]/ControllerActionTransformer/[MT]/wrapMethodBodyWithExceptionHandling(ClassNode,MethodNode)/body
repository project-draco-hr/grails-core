{
  final BlockStatement catchBlockCode=new BlockStatement();
  final String caughtExceptionArgumentName="$caughtException";
  final Expression caughtExceptionVariableExpression=new VariableExpression(caughtExceptionArgumentName);
  final Expression caughtExceptionTypeExpression=new PropertyExpression(caughtExceptionVariableExpression,"class");
  final Expression thisExpression=new VariableExpression("this");
  final MethodCallExpression getExceptionHandlerMethodCall=new MethodCallExpression(thisExpression,"getExceptionHandlerMethodFor",caughtExceptionTypeExpression);
  applyDefaultMethodTarget(getExceptionHandlerMethodCall,controllerClassNode);
  final ClassNode reflectMethodClassNode=new ClassNode(Method.class);
  final String exceptionHandlerMethodVariableName="$method";
  final Expression exceptionHandlerMethodExpression=new VariableExpression(exceptionHandlerMethodVariableName,new ClassNode(Method.class));
  final Expression declareExceptionHandlerMethod=new DeclarationExpression(new VariableExpression(exceptionHandlerMethodVariableName,reflectMethodClassNode),Token.newSymbol(Types.EQUALS,0,0),getExceptionHandlerMethodCall);
  final ArgumentListExpression invokeArguments=new ArgumentListExpression();
  invokeArguments.addExpression(thisExpression);
  invokeArguments.addExpression(caughtExceptionVariableExpression);
  final MethodCallExpression invokeExceptionHandlerMethodExpression=new MethodCallExpression(new VariableExpression(exceptionHandlerMethodVariableName),"invoke",invokeArguments);
  applyDefaultMethodTarget(invokeExceptionHandlerMethodExpression,reflectMethodClassNode);
  final Statement returnStatement=new ReturnStatement(invokeExceptionHandlerMethodExpression);
  final Statement throwCaughtExceptionStatement=new ThrowStatement(caughtExceptionVariableExpression);
  final Statement ifExceptionHandlerMethodExistsStatement=new IfStatement(new BooleanExpression(exceptionHandlerMethodExpression),returnStatement,throwCaughtExceptionStatement);
  catchBlockCode.addStatement(new ExpressionStatement(declareExceptionHandlerMethod));
  catchBlockCode.addStatement(ifExceptionHandlerMethodExistsStatement);
  final CatchStatement catchStatement=new CatchStatement(new Parameter(new ClassNode(Exception.class),caughtExceptionArgumentName),catchBlockCode);
  final Statement methodBody=methodNode.getCode();
  BlockStatement tryBlock=new BlockStatement();
  BlockStatement codeToHandleAllowedMethods=getCodeToHandleAllowedMethods(controllerClassNode,methodNode);
  tryBlock.addStatement(codeToHandleAllowedMethods);
  tryBlock.addStatement(methodBody);
  final TryCatchStatement tryCatchStatement=new TryCatchStatement(tryBlock,new EmptyStatement());
  tryCatchStatement.addCatch(catchStatement);
  final ArgumentListExpression argumentListExpression=new ArgumentListExpression();
  argumentListExpression.addExpression(new ConstantExpression(ALLOWED_METHODS_HANDLED_ATTRIBUTE_NAME));
  final PropertyExpression requestPropertyExpression=new PropertyExpression(new VariableExpression("this"),"request");
  final Expression removeAttributeMethodCall=new MethodCallExpression(requestPropertyExpression,"removeAttribute",argumentListExpression);
  final TryCatchStatement removeAttributeStatement=new TryCatchStatement(new ExpressionStatement(removeAttributeMethodCall),new EmptyStatement());
  removeAttributeStatement.addCatch(new CatchStatement(new Parameter(ClassHelper.make(Exception.class),"$exceptionRemovingAttribute"),new EmptyStatement()));
  tryCatchStatement.setFinallyStatement(removeAttributeStatement);
  methodNode.setCode(tryCatchStatement);
}
