{
  if (showSource) {
    response.setContentType(GROOVY_SOURCE_CONTENT_TYPE);
    writeGroovySourceToResponse(metaInfo,out);
  }
 else {
    if (metaInfo.getCompilationException() != null) {
      throw metaInfo.getCompilationException();
    }
    boolean contentTypeAlreadySet=response.isCommitted() || response.getContentType() != null;
    if (LOG.isDebugEnabled() && !contentTypeAlreadySet) {
      LOG.debug("Writing response to [" + response.getClass() + "] with content type: "+ metaInfo.getContentType());
    }
    if (!contentTypeAlreadySet) {
      response.setContentType(metaInfo.getContentType());
    }
    GroovyPageBinding binding=(GroovyPageBinding)request.getAttribute(GrailsApplicationAttributes.PAGE_SCOPE);
    GroovyPageBinding oldBinding=null;
    if (binding == null) {
      binding=createBinding(metaInfo.getPageClass(),pluginManager);
      formulateBinding(request,response,binding,out);
    }
 else {
      oldBinding=binding;
      binding=createBinding(metaInfo.getPageClass(),pluginManager);
      binding.setPluginContextPath(oldBinding.getPluginContextPath());
      formulateBinding(request,response,binding,out);
    }
    if (metaInfo.getCodecClass() != null) {
      request.setAttribute("org.codehaus.groovy.grails.GSP_CODEC",metaInfo.getCodecName());
      binding.setVariable("Codec",metaInfo.getCodecClass());
    }
 else {
      binding.setVariable("Codec",gspNoneCodeInstance);
    }
    GroovyPage page=(GroovyPage)InvokerHelper.createScript(metaInfo.getPageClass(),binding);
    page.setJspTags(metaInfo.getJspTags());
    page.setJspTagLibraryResolver(metaInfo.getJspTagLibraryResolver());
    page.setGspTagLibraryLookup(metaInfo.getTagLibraryLookup());
    page.setHtmlParts(metaInfo.getHtmlParts());
    page.initRun(out,webRequest);
    try {
      page.run();
    }
  finally {
      page.cleanup();
    }
    request.setAttribute(GrailsApplicationAttributes.PAGE_SCOPE,oldBinding);
  }
  return out;
}
