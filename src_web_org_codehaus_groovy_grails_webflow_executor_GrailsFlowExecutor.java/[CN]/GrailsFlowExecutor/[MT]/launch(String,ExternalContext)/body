{
  if (logger.isDebugEnabled()) {
    logger.debug("Launching flow execution for flow definition '" + flowDefinitionId + "'");
  }
  ExternalContextHolder.setExternalContext(context);
  try {
    FlowDefinition flowDefinition=getDefinitionLocator().getFlowDefinition(flowDefinitionId);
    FlowExecution flowExecution=getExecutionFactory().createFlowExecution(flowDefinition);
    FlowExecutionContextHolder.setFlowExecutionContext(flowExecution);
    ViewSelection selectedView=flowExecution.start(createInput(context),context);
    if (flowExecution.isActive()) {
      final FlowExecutionRepository executionRepository=getExecutionRepository();
      FlowExecutionKey key=executionRepository.generateKey(flowExecution);
      FlowExecutionLock lock=executionRepository.getLock(key);
      lock.lock();
      try {
        executionRepository.putFlowExecution(key,flowExecution);
      }
  finally {
        lock.unlock();
      }
      return new ResponseInstruction(key.toString(),flowExecution,selectedView);
    }
 else {
      return new ResponseInstruction(flowExecution,selectedView);
    }
  }
  finally {
    cleanUpAfterFlowExecution();
  }
}
