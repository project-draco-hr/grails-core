{
  if (shouldFilter) {
    StackTraceElement[] trace=source.getStackTrace();
    List<StackTraceElement> newTrace=new ArrayList<StackTraceElement>();
    boolean foundGroovy=false;
    for (    StackTraceElement stackTraceElement : trace) {
      String className=stackTraceElement.getClassName();
      if (!foundGroovy && stackTraceElement.getFileName().endsWith(".groovy")) {
        foundGroovy=true;
      }
      if (cutOffPackage != null && className.startsWith(cutOffPackage) && foundGroovy)       break;
      if (isApplicationClass(className)) {
        if (stackTraceElement.getLineNumber() > -1) {
          newTrace.add(stackTraceElement);
        }
      }
    }
    if (newTrace.size() > 0) {
      STACK_LOG.error(FULL_STACK_TRACE_MESSAGE,source);
      StackTraceElement[] clean=new StackTraceElement[newTrace.size()];
      newTrace.toArray(clean);
      source.setStackTrace(clean);
    }
  }
  return source;
}
