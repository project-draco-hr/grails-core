{
  String plugin=descriptor.getPlugin();
  if (plugin != null) {
    EnhancedDefaultDependencyDescriptor pluginDependencyDescriptor=(EnhancedDefaultDependencyDescriptor)getPluginDependencyDescriptor(plugin);
    if (pluginDependencyDescriptor != null) {
      ExcludeRule[] excludeRules=pluginDependencyDescriptor.getExcludeRules(scope);
      if (excludeRules != null) {
        for (        ExcludeRule excludeRule : excludeRules) {
          descriptor.addExcludeRule(scope,excludeRule);
        }
      }
      String pluginScope=pluginDependencyDescriptor.getScope();
      if (pluginScope != null) {
        if (isCompileOrRuntimeScope(scope)) {
          scope=pluginScope;
        }
      }
    }
  }
  registerDependencyCommon(scope,descriptor);
  ModuleRevisionId revisionId=descriptor.getDependencyRevisionId();
  modules.add(revisionId.getModuleId());
  dependencies.add(revisionId);
  String org=revisionId.getOrganisation();
  if (orgToDepMap.containsKey(org)) {
    orgToDepMap.get(org).add(revisionId);
  }
 else {
    Collection<ModuleRevisionId> deps=new HashSet<ModuleRevisionId>();
    deps.add(revisionId);
    orgToDepMap.put(org,deps);
  }
  dependencyDescriptors.add(descriptor);
  if (shouldIncludeDependency(descriptor)) {
    moduleDescriptor.addDependency(descriptor);
  }
}
