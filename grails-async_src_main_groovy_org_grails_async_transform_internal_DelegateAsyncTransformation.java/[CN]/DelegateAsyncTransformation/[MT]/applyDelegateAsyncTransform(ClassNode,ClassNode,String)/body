{
  List<MethodNode> methods=targetApi.getAllDeclaredMethods();
  ClassNode promisesClass=ClassHelper.make(Promises.class).getPlainNodeReference();
  MethodNode createPromiseMethodTarget=promisesClass.getDeclaredMethod("createPromise",new Parameter[]{new Parameter(new ClassNode(Closure.class),"c")});
  MethodNode createPromiseMethodTargetWithDecorators=promisesClass.getDeclaredMethod("createPromise",new Parameter[]{new Parameter(new ClassNode(Closure.class),"c"),new Parameter(new ClassNode(List.class),"c")});
  for (  MethodNode m : methods) {
    if (isCandidateMethod(m)) {
      MethodNode existingMethod=classNode.getMethod(m.getName(),m.getParameters());
      if (existingMethod == null) {
        ClassNode promiseNode=ClassHelper.make(Promise.class).getPlainNodeReference();
        ClassNode returnType=m.getReturnType().getPlainNodeReference();
        if (!returnType.getNameWithoutPackage().equals(VOID)) {
          promiseNode.setGenericsTypes(new GenericsType[]{new GenericsType(returnType)});
        }
        final BlockStatement methodBody=new BlockStatement();
        final BlockStatement promiseBody=new BlockStatement();
        final ClosureExpression closureExpression=new ClosureExpression(new Parameter[0],promiseBody);
        VariableScope variableScope=new VariableScope();
        closureExpression.setVariableScope(variableScope);
        MethodCallExpression createPromise=new MethodCallExpression(new ClassExpression(promisesClass),"createPromise",new ArgumentListExpression(closureExpression));
        if (createPromiseMethodTarget != null) {
          createPromise.setMethodTarget(createPromiseMethodTarget);
        }
        VariableExpression thisObject=new VariableExpression("this");
        MethodCallExpression createPromiseWithDecorators=new MethodCallExpression(new ClassExpression(promisesClass),"createPromise",new ArgumentListExpression(closureExpression,new MethodCallExpression(thisObject,"getDecorators",new ArgumentListExpression())));
        if (createPromiseMethodTargetWithDecorators != null) {
          createPromiseWithDecorators.setMethodTarget(createPromiseMethodTargetWithDecorators);
        }
        if (createPromiseMethodTarget != null) {
          createPromise.setMethodTarget(createPromiseMethodTarget);
        }
        BinaryExpression instanceofCheck=new BinaryExpression(thisObject,Token.newSymbol(Types.KEYWORD_INSTANCEOF,-1,-1),new ClassExpression(new ClassNode(PromiseDecoratorProvider.class).getPlainNodeReference()));
        IfStatement ifStatement=new IfStatement(new BooleanExpression(instanceofCheck),new ExpressionStatement(createPromiseWithDecorators),new ExpressionStatement(createPromise));
        methodBody.addStatement(ifStatement);
        final ArgumentListExpression arguments=new ArgumentListExpression();
        Parameter[] parameters=copyParameters(m.getParameters());
        for (        Parameter p : parameters) {
          p.setClosureSharedVariable(true);
          variableScope.putReferencedLocalVariable(p);
          VariableExpression ve=new VariableExpression(p);
          ve.setClosureSharedVariable(true);
          arguments.addExpression(ve);
        }
        MethodCallExpression delegateMethodCall=new MethodCallExpression(new VariableExpression(fieldName),m.getName(),arguments);
        promiseBody.addStatement(new ExpressionStatement(delegateMethodCall));
        MethodNode newMethodNode=new MethodNode(m.getName(),Modifier.PUBLIC,promiseNode,parameters,null,methodBody);
        classNode.addMethod(newMethodNode);
      }
    }
  }
}
