{
  Class<?> type=bean.getPropertyType(propertyName);
  if (type == null) {
    Object target=bean.getWrappedInstance();
    String path=propertyName.replaceAll("\\[.+?\\]","");
    if (path.indexOf(PATH_SEPARATOR) > -1) {
      String nestedProp=GrailsStringUtils.substringBeforeLast(propertyName,".");
      target=bean.getPropertyValue(nestedProp);
      path=GrailsStringUtils.substringAfterLast(path,".");
    }
    if (target != null) {
      type=getReferencedTypeForCollection(path,target);
    }
  }
  return type;
}
