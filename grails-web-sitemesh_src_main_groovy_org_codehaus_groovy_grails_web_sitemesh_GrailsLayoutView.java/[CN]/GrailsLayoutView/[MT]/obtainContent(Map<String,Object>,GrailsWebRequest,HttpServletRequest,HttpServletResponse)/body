{
  Object oldPage=request.getAttribute(RequestConstants.PAGE);
  request.removeAttribute(RequestConstants.PAGE);
  Object oldGspSiteMeshPage=request.getAttribute(GrailsLayoutView.GSP_SITEMESH_PAGE);
  HttpServletResponse previousResponse=webRequest.getWrappedResponse();
  HttpServletResponse previousWrappedResponse=WrappedResponseHolder.getWrappedResponse();
  try {
    request.setAttribute(GrailsLayoutView.GSP_SITEMESH_PAGE,new GSPSitemeshPage());
    GrailsViewBufferingResponse contentBufferingResponse=new GrailsViewBufferingResponse(request,response);
    webRequest.setWrappedResponse(contentBufferingResponse);
    WrappedResponseHolder.setWrappedResponse(contentBufferingResponse);
    innerView.render(model,request,contentBufferingResponse);
    return contentBufferingResponse.getContent();
  }
  finally {
    if (oldGspSiteMeshPage != null) {
      request.setAttribute(GrailsLayoutView.GSP_SITEMESH_PAGE,oldGspSiteMeshPage);
    }
    if (oldPage != null) {
      request.setAttribute(RequestConstants.PAGE,oldPage);
    }
    if (previousResponse != null) {
      webRequest.setWrappedResponse(previousResponse);
    }
    WrappedResponseHolder.setWrappedResponse(previousWrappedResponse);
  }
}
