{
  StringBuilder sb=new StringBuilder();
  sb.append("Exception occurred when processing request: ");
  sb.append("[").append(request.getMethod().toUpperCase()).append("] ");
  if (request.getAttribute(WebUtils.FORWARD_REQUEST_URI_ATTRIBUTE) != null) {
    sb.append(request.getAttribute(WebUtils.FORWARD_REQUEST_URI_ATTRIBUTE));
  }
 else {
    sb.append(request.getRequestURI());
  }
  Map flatConfig=ConfigurationHolder.getFlatConfig();
  final boolean shouldLogRequestParameters;
  if (flatConfig.containsKey("grails.exceptionresolver.logRequestParameters")) {
    shouldLogRequestParameters=Boolean.TRUE.equals(flatConfig.get("grails.exceptionresolver.logRequestParameters"));
  }
 else {
    shouldLogRequestParameters=Environment.getCurrent() != Environment.PRODUCTION;
  }
  if (shouldLogRequestParameters) {
    Enumeration<String> params=request.getParameterNames();
    if (params.hasMoreElements()) {
      String param;
      String values[];
      int i;
      sb.append(" - parameters:");
      List<String> blackList=(List<String>)flatConfig.get("grails.exceptionresolver.params.exclude");
      if (blackList == null) {
        blackList=Collections.emptyList();
      }
      while (params.hasMoreElements()) {
        param=params.nextElement();
        values=request.getParameterValues(param);
        for (i=0; i < values.length; i++) {
          sb.append(LINE_SEPARATOR).append(param).append(": ");
          if (blackList.contains(param)) {
            sb.append("***");
          }
 else {
            sb.append(values[i]);
          }
        }
      }
    }
  }
  sb.append(LINE_SEPARATOR).append("Stacktrace follows:");
  return sb.toString();
}
