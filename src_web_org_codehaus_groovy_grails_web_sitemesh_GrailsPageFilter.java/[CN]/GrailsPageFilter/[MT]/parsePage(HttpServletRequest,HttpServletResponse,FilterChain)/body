{
  try {
    PageResponseWrapper pageResponse=new PageResponseWrapper(response,factory);
    UrlPathHelper urlHelper=new UrlPathHelper();
    String requestURI=urlHelper.getOriginatingRequestUri(request);
    if (requestURI.endsWith(HTML_EXT)) {
      String encoding=(String)ConfigurationHolder.getFlatConfig().get(CONFIG_OPTION_GSP_ENCODING);
      if (encoding == null)       encoding=UTF_8_ENCODING;
      pageResponse.setContentType("text/html;charset=" + encoding);
    }
    chain.doFilter(request,pageResponse);
    Page result=(Page)request.getAttribute(PAGE);
    if (result == null) {
      result=pageResponse.getPage();
    }
    request.setAttribute(USING_STREAM,pageResponse.isUsingStream() ? Boolean.TRUE : Boolean.FALSE);
    return result;
  }
 catch (  IllegalStateException e) {
    if (Container.get() != Container.WEBLOGIC)     throw e;
    return null;
  }
}
