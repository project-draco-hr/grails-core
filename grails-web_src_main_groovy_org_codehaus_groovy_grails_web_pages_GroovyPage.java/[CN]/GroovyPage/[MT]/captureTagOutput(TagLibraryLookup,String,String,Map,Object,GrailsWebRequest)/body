{
  if (!(attrs instanceof GroovyPageAttributes)) {
    attrs=new GroovyPageAttributes(attrs,false);
  }
  ((GroovyPageAttributes)attrs).setGspTagSyntaxCall(false);
  GroovyObject tagLib=lookupCachedTagLib(gspTagLibraryLookup,namespace,tagName);
  if (tagLib == null) {
    throw new GrailsTagException("Tag [" + tagName + "] does not exist. No corresponding tag library found.");
  }
  Closure actualBody=createOutputCapturingClosure(tagLib,body,webRequest);
  final GroovyPageTagWriter tagOutput=new GroovyPageTagWriter();
  GroovyPageOutputStack outputStack=null;
  try {
    outputStack=GroovyPageOutputStack.currentStack(webRequest,false);
    if (outputStack == null) {
      outputStack=GroovyPageOutputStack.currentStack(webRequest,true,tagOutput,true,true);
    }
    Object codecInfo=null;
    if (attrs.containsKey(ENCODE_AS_ATTRIBUTE_NAME)) {
      codecInfo=attrs.get(ENCODE_AS_ATTRIBUTE_NAME);
    }
 else     if (DEFAULT_NAMESPACE.equals(namespace) && APPLY_CODEC_TAG_NAME.equals(tagName)) {
      codecInfo=attrs;
    }
 else {
      codecInfo=gspTagLibraryLookup.getEncodeAsForTag(namespace,tagName);
    }
    GroovyPageOutputStackAttributes.Builder builder=WithCodecHelper.createOutputStackAttributesBuilder(codecInfo,webRequest.getAttributes().getGrailsApplication());
    builder.topWriter(tagOutput);
    outputStack.push(builder.build());
    Object tagLibProp=tagLib.getProperty(tagName);
    if (tagLibProp instanceof Closure) {
      Closure tag=(Closure)((Closure)tagLibProp).clone();
      Object bodyResult;
switch (tag.getParameterTypes().length) {
case 1:
        bodyResult=tag.call(new Object[]{attrs});
      if (actualBody != null && actualBody != EMPTY_BODY_CLOSURE) {
        Object bodyResult2=actualBody.call();
        if (bodyResult2 != null) {
          if (actualBody instanceof ConstantClosure) {
            outputStack.getTemplateWriter().print(bodyResult2);
          }
 else {
            outputStack.getOutWriter().print(bodyResult2);
          }
        }
      }
    break;
case 2:
  bodyResult=tag.call(new Object[]{attrs,actualBody});
break;
default :
throw new GrailsTagException("Tag [" + tagName + "] does not specify expected number of params in tag library ["+ tagLib.getClass().getName()+ "]");
}
Encoder pageEncoder=outputStack.getOutEncoder();
boolean returnsObject=gspTagLibraryLookup.doesTagReturnObject(namespace,tagName);
if (returnsObject && bodyResult != null && !(bodyResult instanceof Writer)) {
if (pageEncoder != null) {
bodyResult=pageEncoder.encode(bodyResult);
}
return bodyResult;
}
if (pageEncoder != null) {
return pageEncoder.encode(tagOutput.getBuffer());
}
 else {
return tagOutput.getBuffer();
}
}
throw new GrailsTagException("Tag [" + tagName + "] does not exist in tag library ["+ tagLib.getClass().getName()+ "]");
}
  finally {
if (outputStack != null) outputStack.pop();
}
}
