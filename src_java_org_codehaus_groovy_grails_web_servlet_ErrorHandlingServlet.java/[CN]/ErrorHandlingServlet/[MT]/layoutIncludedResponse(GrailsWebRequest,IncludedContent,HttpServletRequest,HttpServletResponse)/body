{
  final Factory factory=FactoryHolder.getFactory();
  PageParser parser=getPageParser(factory,response);
  Page p=parser != null ? parser.parse(includeResult.getContentAsCharArray()) : null;
  String layout=p != null ? p.getProperty("meta.layout") : null;
  if (layout != null && p != null) {
    final HTMLPage2Content content=new HTMLPage2Content((HTMLPage)p);
    DecoratorSelector decoratorSelector=new DecoratorMapper2DecoratorSelector(factory.getDecoratorMapper());
    SiteMeshWebAppContext webAppContext=new SiteMeshWebAppContext(request,response,webRequest.getServletContext());
    com.opensymphony.sitemesh.Decorator d=decoratorSelector.selectDecorator(content,webAppContext);
    if (d != null) {
      response.setContentType(includeResult.getContentType());
      d.render(content,webAppContext);
    }
 else {
      writeOriginal(response,includeResult);
    }
  }
 else {
    writeOriginal(response,includeResult);
  }
}
