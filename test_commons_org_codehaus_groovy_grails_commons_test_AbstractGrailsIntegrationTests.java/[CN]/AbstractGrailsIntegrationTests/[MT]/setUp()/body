{
  super.setUp();
  onSetUp();
  ga=new DefaultGrailsApplication(gcl.getLoadedClasses(),gcl);
  parentContext=new MockApplicationContext();
  parentContext.registerMockBean("grailsApplication",ga);
  GrailsRuntimeConfigurator configurator=new GrailsRuntimeConfigurator(ga,parentContext);
  servletContext=new MockServletContext();
  applicationContext=configurator.configure(servletContext);
  if (this.applicationContext.containsBean(GrailsRuntimeConfigurator.SESSION_FACTORY_BEAN)) {
    this.sessionFactory=(SessionFactory)this.applicationContext.getBean(GrailsRuntimeConfigurator.SESSION_FACTORY_BEAN);
    GrailsHibernateUtil.configureDynamicMethods(applicationContext,ga);
    if (!TransactionSynchronizationManager.hasResource(this.sessionFactory)) {
      this.session=this.sessionFactory.openSession();
      TransactionSynchronizationManager.bindResource(this.sessionFactory,new SessionHolder(session));
    }
  }
}
