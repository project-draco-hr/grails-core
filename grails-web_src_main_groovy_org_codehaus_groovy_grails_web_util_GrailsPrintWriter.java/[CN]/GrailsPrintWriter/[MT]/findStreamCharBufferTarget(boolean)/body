{
  boolean allowCaching=markUsed;
  Writer currentOut=getOut();
  if (allowCaching && streamCharBufferTarget != null && previousOut == currentOut) {
    return streamCharBufferTarget;
  }
  Writer target=currentOut;
  while (target instanceof GrailsPrintWriter) {
    GrailsPrintWriter gpr=((GrailsPrintWriter)target);
    if (gpr.isAllowUnwrappingOut()) {
      if (markUsed) {
        gpr.setUsed(true);
      }
      target=gpr.getOut();
    }
 else {
      break;
    }
  }
  Writer result;
  if (target instanceof StreamCharBufferWriter) {
    result=target;
  }
 else {
    result=currentOut;
  }
  if (allowCaching) {
    streamCharBufferTarget=result;
    previousOut=currentOut;
  }
  return result;
}
