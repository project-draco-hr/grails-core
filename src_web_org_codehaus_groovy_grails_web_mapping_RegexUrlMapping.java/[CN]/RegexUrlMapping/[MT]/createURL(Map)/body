{
  if (parameterValues == null)   parameterValues=Collections.EMPTY_MAP;
  StringBuffer uri=new StringBuffer();
  Set usedParams=new HashSet();
  String[] tokens=urlData.getTokens();
  int paramIndex=0;
  for (int i=0; i < tokens.length; i++) {
    String token=tokens[i];
    if (CAPTURED_WILDCARD.equals(token)) {
      ConstrainedProperty prop=this.constraints[paramIndex++];
      String propName=prop.getPropertyName();
      Object value=parameterValues.get(propName);
      usedParams.add(propName);
      if (value == null && !prop.isNullable())       throw new UrlMappingException("Unable to create URL for mapping [" + this + "] and parameters ["+ parameterValues+ "]. Parameter ["+ prop.getPropertyName()+ "] is required, but was not specified!");
 else       if (value == null)       break;
      uri.append(SLASH).append(value);
    }
 else {
      uri.append(SLASH).append(token);
    }
  }
  boolean addedParams=false;
  for (Iterator i=parameterValues.keySet().iterator(); i.hasNext(); ) {
    String name=i.next().toString();
    if (!usedParams.contains(name)) {
      if (!addedParams) {
        uri.append('?');
        addedParams=true;
      }
 else {
        uri.append('&');
      }
      uri.append(name).append('=').append(parameterValues.get(name));
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Created reverse URL mapping [" + uri.toString() + "] for parameters ["+ parameterValues+ "]");
  }
  return uri.toString();
}
