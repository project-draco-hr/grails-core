{
  if (target instanceof GrailsWrappedWriter) {
    GrailsWrappedWriter wrappedWriter=((GrailsWrappedWriter)target);
    if (wrappedWriter.isAllowUnwrappingOut()) {
      target=wrappedWriter.unwrap();
    }
  }
  if (target == writer) {
    throw new IllegalArgumentException("Cannot write buffer to itself.");
  }
  if (!emptyAfter && target instanceof StreamCharBufferWriter) {
    ((StreamCharBufferWriter)target).write(this);
    return;
  }
 else   if (target instanceof EncodedAppenderFactory) {
    EncodedAppenderFactory eaw=(EncodedAppenderFactory)target;
    EncodedAppender appender=eaw.getEncodedAppender();
    if (appender != null) {
      if (appender == writer.getEncodedAppender()) {
        throw new IllegalArgumentException("Cannot write buffer to itself.");
      }
      Encoder encoder=null;
      if (target instanceof EncoderAware) {
        encoder=((EncoderAware)target).getEncoder();
      }
      if (encoder == null && appender instanceof EncoderAware) {
        encoder=((EncoderAware)appender).getEncoder();
      }
      encodeTo(appender,encoder);
      if (emptyAfter) {
        emptyAfterReading();
      }
      if (flushTarget) {
        target.flush();
      }
      return;
    }
  }
  writeToImpl(target,flushTarget,emptyAfter);
}
