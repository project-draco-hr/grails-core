{
  if (object instanceof GroovyObject) {
    GroovyObject go=(GroovyObject)object;
    if (go.getMetaClass() instanceof ProxyMetaClass) {
      go.setMetaClass(((ProxyMetaClass)go.getMetaClass()).getAdaptee());
    }
  }
  LinkedList classChain=new LinkedList();
  Class clazz=object.getClass();
  while (clazz != Object.class) {
    classChain.addFirst(clazz);
    clazz=clazz.getSuperclass();
  }
  ConstrainedPropertyBuilder delegate=new ConstrainedPropertyBuilder(object);
  for (Iterator it=classChain.iterator(); it.hasNext(); ) {
    clazz=(Class)it.next();
    Closure c=(Closure)GrailsClassUtils.getStaticPropertyValue(clazz,PROPERTY_NAME);
    if (c == null) {
      c=getConstraintsFromScript(object);
    }
    if (c != null) {
      c.setDelegate(delegate);
      c.call();
    }
 else {
      LOG.debug("User-defined constraints not found on class [" + clazz + "], applying default constraints");
    }
  }
  Map constrainedProperties=delegate.getConstrainedProperties();
  if (this.properties != null) {
    for (int i=0; i < this.properties.length; i++) {
      GrailsDomainClassProperty p=this.properties[i];
      ConstrainedProperty cp=(ConstrainedProperty)constrainedProperties.get(p.getName());
      if (cp == null) {
        cp=new ConstrainedProperty(p.getDomainClass().getClazz(),p.getName(),p.getType());
        cp.setOrder(constrainedProperties.size() + 1);
        constrainedProperties.put(p.getName(),cp);
      }
      if (!cp.hasAppliedConstraint(ConstrainedProperty.NULLABLE_CONSTRAINT)) {
        cp.applyConstraint(ConstrainedProperty.NULLABLE_CONSTRAINT,Boolean.valueOf(p.isOptional() || Collection.class.isAssignableFrom(p.getType()) || Map.class.isAssignableFrom(p.getType())));
      }
    }
  }
  return constrainedProperties;
}
