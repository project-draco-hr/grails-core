{
  String environment=GrailsUtil.getEnvironment();
  if (log.isDebugEnabled()) {
    log.debug("[GrailsApplication] Retrieving data source for environment: " + environment);
  }
  if (StringUtils.isBlank(environment)) {
    environment=GrailsApplication.ENV_PRODUCTION;
    String envPropName=GrailsClassUtils.getClassNameRepresentation(environment) + DataSourceArtefactHandler.TYPE;
    GrailsDataSource devDataSource=(GrailsDataSource)getArtefact(DataSourceArtefactHandler.TYPE,envPropName);
    if (devDataSource == null) {
      devDataSource=(GrailsDataSource)getArtefact(DataSourceArtefactHandler.TYPE,GrailsClassUtils.getClassNameRepresentation(GrailsApplication.ENV_APPLICATION));
    }
    if (getArtefactCount(DataSourceArtefactHandler.TYPE) == 1 && devDataSource == null) {
      devDataSource=(GrailsDataSource)getFirstArtefact(DataSourceArtefactHandler.TYPE);
    }
    return devDataSource;
  }
 else {
    String envPropName=GrailsClassUtils.getClassNameRepresentation(environment) + DataSourceArtefactHandler.TYPE;
    GrailsDataSource dataSource=(GrailsDataSource)getArtefact(DataSourceArtefactHandler.TYPE,envPropName);
    if (dataSource == null && GrailsApplication.ENV_DEVELOPMENT.equalsIgnoreCase(environment)) {
      dataSource=(GrailsDataSource)getArtefact(DataSourceArtefactHandler.TYPE,GrailsClassUtils.getClassNameRepresentation(GrailsApplication.ENV_APPLICATION));
    }
    if (dataSource == null) {
      log.warn("No data source found for environment [" + environment + "]. Please specify alternative via -Dgrails.env=myenvironment");
    }
    return dataSource;
  }
}
