{
  String uri=urlHelper.getPathWithinApplication(request);
  if (logger.isDebugEnabled()) {
    logger.debug("Looking up Grails controller for URI [" + uri + "]");
  }
  GrailsControllerClass controllerClass;
  Object controllerAttribute=null;
  GrailsWebRequest webRequest=(GrailsWebRequest)request.getAttribute(GrailsApplicationAttributes.WEB_REQUEST);
  if (webRequest != null) {
    controllerAttribute=webRequest.getAttribute(GrailsApplicationAttributes.GRAILS_CONTROLLER_CLASS,WebRequest.SCOPE_REQUEST);
    String matchedUri=(String)webRequest.getAttribute(GrailsApplicationAttributes.GRAILS_CONTROLLER_CLASS_MATCHED_URI,WebRequest.SCOPE_REQUEST);
    if (matchedUri == null || !matchedUri.equals(uri)) {
      controllerAttribute=null;
    }
  }
  if (controllerAttribute instanceof GrailsControllerClass) {
    controllerClass=(GrailsControllerClass)controllerAttribute;
  }
 else {
    controllerClass=(GrailsControllerClass)grailsApplication.getArtefactForFeature(ControllerArtefactHandler.TYPE,uri);
  }
  return getHandlerForControllerClass(controllerClass,request);
}
