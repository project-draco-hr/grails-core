{
  Assert.notNull(application);
  WebApplicationContext ctx;
  try {
    WebRuntimeSpringConfiguration springConfig=createWebRuntimeSpringConfiguration(application,parent,application.getClassLoader());
    springConfig.setBeanFactory(new ReloadAwareAutowireCapableBeanFactory());
    if (context != null) {
      springConfig.setServletContext(context);
      pluginManager.setServletContext(context);
    }
    if (!pluginManager.isInitialised()) {
      pluginManager.loadPlugins();
    }
    if (!application.isInitialised()) {
      pluginManager.doArtefactConfiguration();
      application.initialise();
    }
    pluginManager.registerProvidedArtefacts(application);
    registerParentBeanFactoryPostProcessors(springConfig);
    pluginManager.doRuntimeConfiguration(springConfig);
    LOG.debug("[RuntimeConfiguration] Processing additional external configurations");
    if (loadExternalBeans) {
      doPostResourceConfiguration(application,springConfig);
    }
    reset();
    application.setMainContext(springConfig.getUnrefreshedApplicationContext());
    ctx=(WebApplicationContext)springConfig.getApplicationContext();
    pluginManager.setApplicationContext(ctx);
    pluginManager.doDynamicMethods();
    ctx.publishEvent(new GrailsContextEvent(ctx,GrailsContextEvent.DYNAMIC_METHODS_REGISTERED));
    performPostProcessing(ctx);
    application.refreshConstraints();
  }
  finally {
    ClassPropertyFetcher.clearClassPropertyFetcherCache();
    MethodUtils.clearCache();
  }
  return ctx;
}
