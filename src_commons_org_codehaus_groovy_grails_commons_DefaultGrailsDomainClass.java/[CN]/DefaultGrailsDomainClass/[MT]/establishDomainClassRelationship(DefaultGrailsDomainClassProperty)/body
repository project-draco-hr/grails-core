{
  Class propType=property.getType();
  if (embedded.contains(property.getName())) {
    property.setEmbedded(true);
    return;
  }
  Map relatedClassRelationships=GrailsDomainConfigurationUtil.getAssociationMap(propType);
  Map mappedBy=GrailsDomainConfigurationUtil.getMappedByMap(propType);
  Class relatedClassPropertyType=null;
  if (relatedClassRelationships != null && !relatedClassRelationships.isEmpty()) {
    String relatedClassPropertyName=findOneToManyThatMatchesType(property,relatedClassRelationships);
    PropertyDescriptor[] descriptors=GrailsClassUtils.getPropertiesOfType(getClazz(),property.getType());
    if (descriptors.length == 1) {
      if (!StringUtils.isBlank(relatedClassPropertyName)) {
        property.setReferencePropertyName(relatedClassPropertyName);
        relatedClassPropertyType=GrailsClassUtils.getPropertyType(propType,relatedClassPropertyName);
      }
    }
 else     if (descriptors.length > 1) {
      if (mappedBy.containsValue(property.getName())) {
        for (Iterator i=mappedBy.keySet().iterator(); i.hasNext(); ) {
          String key=(String)i.next();
          if (property.getName().equals(mappedBy.get(key))) {
            relatedClassPropertyType=GrailsClassUtils.getPropertyType(propType,key);
          }
        }
      }
 else {
        String classNameAsProperty=GrailsClassUtils.getPropertyName(propType);
        if (property.getName().equals(classNameAsProperty) && !mappedBy.containsKey(relatedClassPropertyName)) {
          relatedClassPropertyType=GrailsClassUtils.getPropertyType(propType,relatedClassPropertyName);
        }
      }
    }
  }
  if (relatedClassPropertyType == null) {
    PropertyDescriptor[] descriptors=GrailsClassUtils.getPropertiesOfType(propType,getClazz());
    if (descriptors.length == 1) {
      relatedClassPropertyType=descriptors[0].getPropertyType();
    }
  }
  establishDomainClassRelationshipToType(property,relatedClassPropertyType);
}
