{
  SessionFactory sessionFactory=(SessionFactory)webContext.getBean(GrailsRuntimeConfigurator.SESSION_FACTORY_BEAN);
  if (sessionFactory != null) {
    Session session=null;
    boolean participate=false;
    if (TransactionSynchronizationManager.hasResource(sessionFactory)) {
      participate=true;
    }
 else {
      LOG.debug("Opening single Hibernate session in GrailsDispatcherServlet");
      session=SessionFactoryUtils.getSession(sessionFactory,true);
      session.setFlushMode(FlushMode.AUTO);
      TransactionSynchronizationManager.bindResource(sessionFactory,new SessionHolder(session));
    }
    try {
      GrailsBootstrapClass[] bootstraps=application.getGrailsBootstrapClasses();
      for (int i=0; i < bootstraps.length; i++) {
        bootstraps[i].callInit(servletContext);
      }
      if (!participate) {
        if (!FlushMode.NEVER.equals(session.getFlushMode())) {
          session.flush();
        }
      }
    }
  finally {
      if (!participate) {
        TransactionSynchronizationManager.unbindResource(sessionFactory);
        LOG.debug("Closing single Hibernate session in GrailsDispatcherServlet");
        try {
          SessionFactoryUtils.releaseSession(session,sessionFactory);
        }
 catch (        RuntimeException ex) {
          LOG.error("Unexpected exception on closing Hibernate Session",ex);
        }
      }
    }
  }
}
