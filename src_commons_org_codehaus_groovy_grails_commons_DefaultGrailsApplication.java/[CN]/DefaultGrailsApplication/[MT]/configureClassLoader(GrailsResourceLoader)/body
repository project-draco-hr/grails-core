{
  final ClassLoader contextLoader=Thread.currentThread().getContextClassLoader();
  ClassLoader rootLoader=DefaultGroovyMethods.getRootLoader(contextLoader);
  ClassLoader parentLoader=beanClassLoader != null ? beanClassLoader : contextLoader;
  GroovyClassLoader cl;
  if (rootLoader != null) {
    cl=new GrailsClassLoader(contextLoader,resourceLoader);
  }
 else {
    GrailsAwareClassLoader gcl=new GrailsAwareClassLoader(contextLoader);
    if (resourceLoader != null)     gcl.setResourceLoader(resourceLoader);
    gcl.setClassInjectors(new ClassInjector[]{new DefaultGrailsDomainClassInjector()});
    cl=gcl;
  }
  Thread.currentThread().setContextClassLoader(cl);
  return cl;
}
