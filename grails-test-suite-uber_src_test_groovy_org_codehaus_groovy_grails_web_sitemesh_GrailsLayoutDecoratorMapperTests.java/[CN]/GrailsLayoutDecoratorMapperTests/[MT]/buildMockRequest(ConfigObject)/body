{
  MockApplicationContext appCtx=new MockApplicationContext();
  appCtx.registerMockBean(GroovyPagesUriService.BEAN_ID,new DefaultGroovyPagesUriService());
  DefaultGrailsApplication grailsApplication=new DefaultGrailsApplication();
  grailsApplication.setConfig(config);
  appCtx.registerMockBean(GrailsApplication.APPLICATION_ID,grailsApplication);
  GrailsConventionGroovyPageLocator pageLocator=new GrailsConventionGroovyPageLocator();
  pageLocator.setApplicationContext(appCtx);
  GroovyPageLayoutFinder layoutFinder=new GroovyPageLayoutFinder();
  layoutFinder.setGroovyPageLocator(pageLocator);
  @SuppressWarnings("rawtypes") Map flat=config != null ? config.flatten() : Collections.emptyMap();
  layoutFinder.setDefaultDecoratorName(flat.get("grails.sitemesh.default.layout") != null ? flat.get("grails.sitemesh.default.layout").toString() : "application");
  appCtx.registerMockBean("groovyPageLocator",pageLocator);
  appCtx.registerMockBean("groovyPageLayoutFinder",layoutFinder);
  appCtx.getServletContext().setAttribute(GrailsApplicationAttributes.APPLICATION_CONTEXT,appCtx);
  appCtx.getServletContext().setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE,appCtx);
  return GrailsWebUtil.bindMockWebRequest(appCtx);
}
