{
  WebApplicationContext parent=WebApplicationContextUtils.getRequiredWebApplicationContext(getServletContext());
  ApplicationContext context;
  if (getServletContext().getAttribute(GrailsRequestAttributes.APPLICATION_CONTEXT) == null) {
    GrailsApplication application=(GrailsApplication)parent.getBean(GrailsApplication.APPLICATION_ID,GrailsApplication.class);
    SpringConfig springConfig=new SpringConfig(application);
    context=new XmlApplicationContextDriver().getApplicationContext(springConfig.getBeanReferences(),parent);
    getServletContext().setAttribute(GrailsRequestAttributes.APPLICATION_CONTEXT,context);
  }
 else {
    context=(ApplicationContext)getServletContext().getAttribute(GrailsRequestAttributes.APPLICATION_CONTEXT);
  }
  return (SessionFactory)context.getBean(getSessionFactoryBeanName(),SessionFactory.class);
}
