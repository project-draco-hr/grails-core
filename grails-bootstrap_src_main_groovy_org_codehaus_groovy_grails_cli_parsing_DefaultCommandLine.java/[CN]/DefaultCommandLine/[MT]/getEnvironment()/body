{
  boolean useDefaultEnv=environment == null;
  String env;
  if (useDefaultEnv && commandName != null) {
    env=lookupEnvironmentForCommand();
  }
 else {
    env=environment != null ? environment : Environment.DEVELOPMENT.getName();
  }
  System.setProperty(Environment.KEY,env);
  System.setProperty(Environment.DEFAULT,String.valueOf(useDefaultEnv));
  return env;
}
