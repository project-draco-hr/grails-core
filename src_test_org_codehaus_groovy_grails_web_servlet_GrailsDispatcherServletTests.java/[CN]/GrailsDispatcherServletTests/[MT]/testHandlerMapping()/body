{
  final MockApplicationContext appCtx=new MockApplicationContext();
  try {
    System.setProperty("grails.env","development");
    appCtx.registerMockBean("localeInterceptor",new LocaleChangeInterceptor());
    appCtx.registerMockBean("openSessionInView",new OpenSessionInViewInterceptor());
    SimpleGrailsController controller=new SimpleGrailsController();
    appCtx.registerMockBean("mainSimpleController",controller);
    GrailsControllerHandlerMapping handlerMapping=new GrailsControllerHandlerMapping();
    appCtx.registerMockBean("controllerHandlerMappings",handlerMapping);
    GrailsDispatcherServlet dispatcherServlet=new GrailsDispatcherServlet(){
      @Override protected WebApplicationContext initWebApplicationContext() throws BeansException {
        initStrategies(appCtx);
        return appCtx;
      }
    }
;
    GroovyClassLoader cl=new GroovyClassLoader();
    cl.parseClass("class TestController {" + "def action = {} " + "}");
    final DefaultGrailsApplication grailsApplication=new DefaultGrailsApplication(cl.getLoadedClasses(),cl);
    grailsApplication.initialise();
    handlerMapping.setGrailsApplication(grailsApplication);
    handlerMapping.setApplicationContext(appCtx);
    dispatcherServlet.setApplication(grailsApplication);
    dispatcherServlet.init(new MockServletConfig(new MockServletContext()));
    MockHttpServletRequest request=new MockHttpServletRequest("GET","/test/action");
    HandlerExecutionChain executionChain=dispatcherServlet.getHandler(request,true);
    assertNotNull(executionChain);
    assertEquals(2,executionChain.getInterceptors().length);
    for (int i=0; i < executionChain.getInterceptors().length; i++) {
      HandlerInterceptor interceptor=executionChain.getInterceptors()[i];
      assertNotNull(interceptor);
    }
    request=new MockHttpServletRequest("GET","/test/action/1");
    executionChain=dispatcherServlet.getHandler(request,true);
    assertNotNull(executionChain);
    request=new MockHttpServletRequest("GET","/test/action/1/param/value");
    executionChain=dispatcherServlet.getHandler(request,true);
    assertNotNull(executionChain);
    request=new MockHttpServletRequest("GET","/context/rubbish/action");
    executionChain=dispatcherServlet.getHandler(request,true);
    assertNull(executionChain);
  }
  finally {
    System.setProperty("grails.env","");
  }
}
