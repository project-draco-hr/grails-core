{
  HttpServletRequest request=(HttpServletRequest)rq;
  HttpServletResponse response=(HttpServletResponse)rs;
  ServletContext servletContext=filterConfig.getServletContext();
  SiteMeshWebAppContext webAppContext=new SiteMeshWebAppContext(request,response,servletContext);
  if (filterAlreadyAppliedForRequest(request)) {
    chain.doFilter(request,response);
    return;
  }
  if (!contentProcessor.handles(webAppContext)) {
    chain.doFilter(request,response);
    return;
  }
  request.removeAttribute(RequestConstants.PAGE);
  if (containerTweaks.shouldAutoCreateSession()) {
    request.getSession(true);
  }
  boolean dispatched=false;
  try {
    Content content=obtainContent(contentProcessor,webAppContext,request,response,chain);
    if (content == null || response.isCommitted()) {
      return;
    }
    detectContentTypeFromPage(content,response);
    com.opensymphony.module.sitemesh.Decorator decorator=decoratorMapper.getDecorator(request,GSPSitemeshPage.content2htmlPage(content));
    persistenceInterceptor.reconnect();
    if (decorator instanceof Decorator) {
      ((Decorator)decorator).render(content,webAppContext);
    }
 else {
      new OldDecorator2NewDecorator(decorator).render(content,webAppContext);
    }
    dispatched=true;
  }
 catch (  IllegalStateException e) {
    if (!containerTweaks.shouldIgnoreIllegalStateExceptionOnErrorPage()) {
      throw e;
    }
  }
 finally {
    if (!dispatched) {
      request.setAttribute(ALREADY_APPLIED_KEY,null);
    }
    if (persistenceInterceptor.isOpen()) {
      persistenceInterceptor.destroy();
    }
  }
}
