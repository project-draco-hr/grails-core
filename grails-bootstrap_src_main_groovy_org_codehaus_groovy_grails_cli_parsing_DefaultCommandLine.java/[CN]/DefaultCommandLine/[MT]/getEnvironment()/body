{
  boolean useDefaultEnv=environment == null;
  String env;
  if (useDefaultEnv && commandName != null) {
    env=CommandLineParser.DEFAULT_ENVS.get(commandName);
    env=env != null ? env : Environment.DEVELOPMENT.getName();
  }
 else {
    env=environment;
  }
  System.setProperty(Environment.KEY,env);
  System.setProperty(Environment.DEFAULT,String.valueOf(useDefaultEnv));
  return env;
}
