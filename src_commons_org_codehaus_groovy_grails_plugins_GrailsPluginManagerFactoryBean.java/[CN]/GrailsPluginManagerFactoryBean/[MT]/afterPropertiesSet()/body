{
  this.pluginManager=PluginManagerHolder.getPluginManager();
  if (pluginManager == null) {
    if (descriptor == null)     throw new IllegalStateException("Cannot create PluginManager, /WEB-INF/grails.xml not found!");
    GroovyClassLoader classLoader=application.getClassLoader();
    List classes=new ArrayList();
    InputStream inputStream=null;
    try {
      inputStream=descriptor.getInputStream();
      XPath xpath=XPathFactory.newInstance().newXPath();
      NodeList nodes=(NodeList)xpath.evaluate("/grails/plugins/plugin",new InputSource(inputStream),XPathConstants.NODESET);
      for (int i=0; i < nodes.getLength(); i++) {
        Node node=nodes.item(i);
        final String pluginName=node.getTextContent();
        classes.add(classLoader.loadClass(pluginName));
      }
    }
  finally {
      if (inputStream != null)       inputStream.close();
    }
    Class[] loadedPlugins=(Class[])classes.toArray(new Class[classes.size()]);
    pluginManager=new DefaultGrailsPluginManager(loadedPlugins,application);
    pluginManager.setApplicationContext(applicationContext);
    PluginManagerHolder.setPluginManager(pluginManager);
    pluginManager.loadPlugins();
  }
  this.pluginManager.setApplication(application);
  this.pluginManager.doArtefactConfiguration();
  application.initialise();
}
