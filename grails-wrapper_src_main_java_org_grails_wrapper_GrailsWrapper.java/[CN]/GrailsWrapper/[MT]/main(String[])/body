{
  ResourceBundle bundle=ResourceBundle.getBundle("grails-wrapper");
  final String grailsVersion=bundle.getString("wrapper.version");
  final File grailsCacheDir=new File(System.getProperty("user.home") + "/.grails/");
  final File grailsVersionDir=new File(grailsCacheDir,grailsVersion);
  final File wrapperDir=new File(grailsVersionDir,"wrapper");
  String distUrl=bundle.getString("wrapper.dist.url");
  if (distUrl == null) {
    distUrl="http://dist.springframework.org.s3.amazonaws.com/release/GRAILS/";
  }
  if (!distUrl.endsWith("/")) {
    distUrl+="/";
  }
  final String src=distUrl + "grails-" + grailsVersion+ ".zip";
  final URI uri=new URI(src);
  final File file=new File(wrapperDir,"download.zip");
  new RemoteFileHelper().retrieve(uri,file);
  final File installDir=new File(wrapperDir,"install");
  if (!installDir.exists()) {
    extract(file,installDir);
  }
  final File grailsHome=new File(installDir,"grails-" + grailsVersion);
  System.setProperty("grails.home",grailsHome.getAbsolutePath());
  final List<String> newArgsList=new ArrayList<String>();
  for (int i=0; i < args.length; i++) {
    final String arg=args[i];
    if ("--main".equals(arg) && i < args.length - 1) {
      i++;
    }
 else     if ("--conf".equals(arg) && i < args.length - 1) {
      newArgsList.add(arg);
      final File groovyStarterConf=new File(grailsHome,"conf/groovy-starter.conf");
      newArgsList.add(groovyStarterConf.getAbsolutePath());
      i++;
    }
 else {
      newArgsList.add(arg);
    }
  }
  final String[] newArgsArray=newArgsList.toArray(new String[0]);
  final URL[] urls=new URL[2];
  urls[0]=new File(grailsHome,"dist/grails-bootstrap-" + grailsVersion + ".jar").toURI().toURL();
  File[] groovyJarCandidates=new File(grailsHome,"lib/org.codehaus.groovy/groovy-all/jars/").listFiles(new FilenameFilter(){
    public boolean accept(    final File dir,    final String name){
      return name.startsWith("groovy-all-") && name.endsWith(".jar");
    }
  }
);
  urls[1]=groovyJarCandidates[0].toURI().toURL();
  final URLClassLoader urlClassLoader=new URLClassLoader(urls);
  final Class<?> loadClass=urlClassLoader.loadClass("org.codehaus.groovy.grails.cli.support.GrailsStarter");
  final Method mainMethod=loadClass.getMethod("main",String[].class);
  mainMethod.invoke(null,new Object[]{newArgsArray});
}
