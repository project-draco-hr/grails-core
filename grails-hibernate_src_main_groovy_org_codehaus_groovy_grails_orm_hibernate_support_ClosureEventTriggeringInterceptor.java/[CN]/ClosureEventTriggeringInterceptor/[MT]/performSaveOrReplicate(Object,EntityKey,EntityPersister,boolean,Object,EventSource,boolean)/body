{
  validate(entity,persister,source);
  Serializable id=key == null ? null : key.getIdentifier();
  source.getPersistenceContext().addEntry(entity,Status.SAVING,null,null,id,null,LockMode.WRITE,useIdentityColumn,persister,false,false);
  cascadeBeforeSave(source,persister,entity,anything);
  log.trace("executing insertions");
  source.getActionQueue().executeInserts();
  Object[] values=persister.getPropertyValuesToInsert(entity,getMergeMap(anything),source);
  Type[] types=persister.getPropertyTypes();
  boolean substitute=substituteValuesIfNecessary(entity,id,values,persister,source);
  if (persister.hasCollections()) {
    substitute=substitute || visitCollectionsBeforeSave(entity,id,values,types,source);
  }
  if (substitute) {
    persister.setPropertyValues(entity,values,source.getEntityMode());
  }
  TypeHelper.deepCopy(values,types,persister.getPropertyUpdateability(),values,source);
  new ForeignKeys.Nullifier(entity,false,useIdentityColumn,source).nullifyTransientReferences(values,types);
  boolean insertVetoed=false;
  if (useIdentityColumn) {
    EntityIdentityInsertAction insert=new EntityIdentityInsertAction(values,entity,persister,source,false);
    log.debug("executing identity-insert immediately");
    source.getActionQueue().execute(insert);
    id=insert.getGeneratedId();
    if (id != null) {
      key=new EntityKey(id,persister,source.getEntityMode());
      source.getPersistenceContext().checkUniqueness(key,entity);
    }
 else {
      insertVetoed=true;
    }
  }
  if (!insertVetoed) {
    Object version=Versioning.getVersion(values,persister);
    source.getPersistenceContext().addEntity(entity,(persister.isMutable() ? Status.MANAGED : Status.READ_ONLY),values,key,version,LockMode.WRITE,useIdentityColumn,persister,isVersionIncrementDisabled(),false);
    if (!useIdentityColumn) {
      EntityInsertAction insert=new EntityInsertAction(id,values,entity,version,persister,source);
      source.getActionQueue().execute(insert);
      if (!source.getPersistenceContext().wasInsertedDuringTransaction(persister,id)) {
        insertVetoed=true;
      }
    }
    if (!insertVetoed) {
      cascadeAfterSave(source,persister,entity,anything);
      if (markInterceptorDirtyMethod != null) {
        ReflectionUtils.invokeMethod(markInterceptorDirtyMethod,this,entity,persister,source);
      }
    }
  }
  return id;
}
